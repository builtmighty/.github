# Built Mighty Deployment
name: üöÄ Deployment

on:
  workflow_call:
    inputs:
      site_url:
        description: 'Site URL'
        required: true
        type: string
      environment: 
        description: 'Deployment environment name'
        required: false
        type: string
        default: 'production'
      exclude_patterns:
        description: 'Additional rsync exclude patterns (comma-separated)'
        required: false
        type: string
        default: ''
    secrets:
      remote_host:
        description: 'Server hostname'
        required: true
      remote_user:
        description: 'Server SSH user'
        required: true
      remote_path:
        description: 'Server deployment path'
        required: true
      remote_port:
        description: 'Server SSH port'
        required: false
      ssh_private_key:
        description: 'SSH private key for deployment'
        required: true
      slack_channel_id:
        description: 'Slack channel ID for notifications'
        required: true
      slack_team_id:
        description: 'Slack team ID for notifications'
        required: false
      slack_bot_token:
        description: 'API key for Slack bot'
        required: true

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ssh_private_key }}
      
      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p ${{ secrets.remote_port || '22' }} ${{ secrets.remote_host }} >> ~/.ssh/known_hosts
    
      - uses: chrnorm/deployment-action@v2
        name: Create GitHub Deployment
        id: github_deployment
        with:
          token: '${{ github.token }}'
          environment-url: ${{ inputs.site_url }}
          environment: ${{ inputs.environment }}
      
      - name: Record Deployment Start Time
        id: deployment_timer
        run: |
          echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "üïê Deployment started at $(date '+%Y-%m-%d %H:%M:%S %Z')"
      
      - name: Enable Maintenance Mode
        run: |
          echo "Enabling maintenance mode..."
          ssh -p ${{ secrets.remote_port || '22' }} ${{ secrets.remote_user }}@${{ secrets.remote_host }} "echo '<?php \$upgrading = time(); ?>' > ${{ secrets.remote_path }}/.maintenance"
          echo "‚úì Maintenance mode enabled"
      
      - name: Build rsync Exclude Parameters
        id: rsync-excludes
        run: |
          # Base excludes
          EXCLUDES="--exclude=.git/ --exclude=node_modules/ --exclude=.github/ --exclude=.gitignore --exclude=deploy.sh --exclude=wp-config.php --exclude=wp-content/uploads/ --exclude=.htaccess --exclude=.claude/ --exclude='*.md'"
          
          # Add custom excludes if provided
          if [ -n "${{ inputs.exclude_patterns }}" ]; then
            IFS=',' read -ra PATTERNS <<< "${{ inputs.exclude_patterns }}"
            for pattern in "${PATTERNS[@]}"; do
              EXCLUDES="$EXCLUDES --exclude=${pattern}"
            done
          fi
          
          echo "excludes=$EXCLUDES" >> $GITHUB_OUTPUT
      
      - name: Sync Files to Deployment Target
        run: |
          echo "Syncing files to deployment target..."
          rsync -avz \
            --checksum \
            --itemize-changes \
            --stats \
            --timeout=120 \
            --delete-after \
            ${{ steps.rsync-excludes.outputs.excludes }} \
            -e "ssh -p ${{ secrets.remote_port || '22' }}" \
            ./ ${{ secrets.remote_user }}@${{ secrets.remote_host }}:${{ secrets.remote_path }}/
          echo "‚úì Files synced"

      - name: Disable Maintenance Mode
        if: always()
        run: |
          echo "Disabling maintenance mode..."
          ssh -p ${{ secrets.remote_port || '22' }} ${{ secrets.remote_user }}@${{ secrets.remote_host }} "rm -f ${{ secrets.remote_path }}/.maintenance && cd ${{ secrets.remote_path }} && wp core check-update --force-check --allow-root"
          echo "‚úì Maintenance mode disabled"

      - name: Flush Caches
        if: success()
        run: |
          echo "Flushing WordPress caches..."
          ssh -p ${{ secrets.remote_port || '22' }} ${{ secrets.remote_user }}@${{ secrets.remote_host }} "cd ${{ secrets.remote_path }} && wp cache flush --allow-root && wp rewrite flush --allow-root"
          echo "‚úì Caches flushed"
      
      - name: Post-Deployment Health Check
        if: success()
        run: |
          echo "Running health check on ${{ inputs.site_url }}..."
          
          # Wait a moment for services to stabilize
          sleep 3
          
          # Make request and capture HTTP status
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 "${{ inputs.site_url }}")
          
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
            echo "‚úì Health check passed! Site is responding with status $HTTP_STATUS"
          else
            echo "‚ö† Health check warning: Site returned status $HTTP_STATUS"
            echo "This may indicate an issue, but deployment will continue."
          fi

      - name: Delete Feature Branch After Staging Deployment
        if: success() && inputs.environment == 'staging'
        run: |
          # Get the source branch from the merge commit
          BRANCH_NAME=$(git log -1 --pretty=%B | grep -oP "Merge pull request #\d+ from [^/]+/\K.*" || echo "")
          
          # Fallback: try to get from commit message in different merge formats
          if [ -z "$BRANCH_NAME" ]; then
            BRANCH_NAME=$(git log -1 --pretty=%B | grep -oP "Merge branch '\K[^']+")
          fi
          
          if [ -z "$BRANCH_NAME" ]; then
            echo "‚ö† Could not determine source branch from merge commit"
            exit 0
          fi
          
          echo "Source branch to potentially delete: $BRANCH_NAME"
          
          # Don't delete protected branches
          case "$BRANCH_NAME" in
            main|master|develop|rc/*)
              echo "‚ö† Skipping deletion of protected branch: $BRANCH_NAME"
              exit 0
              ;;
          esac
          
          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" > /dev/null 2>&1; then
            echo "Branch $BRANCH_NAME exists remotely"
            
            # Delete the branch
            if git push origin --delete "$BRANCH_NAME"; then
              echo "‚úì Successfully deleted branch: $BRANCH_NAME"
            else
              echo "‚úó Failed to delete branch: $BRANCH_NAME"
              exit 1
            fi
          else
            echo "‚ö† Branch $BRANCH_NAME does not exist remotely (may have been already deleted)"
          fi

      - name: Successful GitHub Deployment
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          environment-url: ${{ steps.github_deployment.outputs.environment_url }}
          deployment-id: ${{ steps.github_deployment.outputs.deployment_id }}
          state: 'success'
      
      - name: Failed GitHub Deployment
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          environment-url: ${{ steps.github_deployment.outputs.environment_url }}
          deployment-id: ${{ steps.github_deployment.outputs.deployment_id }}
          state: 'failure'

      - name: Slack Failure Notification
        id: slack_failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.slack_channel_id }}
          payload: |
            {
              "text":"ü§Ø Failed ${{ inputs.environment }} deployment",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ü§Ø Failed ${{ inputs.environment }} deployment* | Looks like something went wrong with the deployment. Check the logs."
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.slack_bot_token }}

      - name: Slack Success Notification
        id: slack_success
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.slack_channel_id }}
          payload: |
            {
              "text":"üöÄ ${{ inputs.environment }} deployment successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üöÄ ${{ inputs.environment }} deployment successful* | We had a successful deployment to ${{ inputs.environment }} from ${{ github.triggering_actor }}!"
                  },
                  "accessory": {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üîó View ${{ inputs.environment }}",
                      "emoji": true
                    },
                    "value": "click_me_123",
                    "url": "${{ inputs.site_url }}",
                    "action_id": "button-action"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.slack_bot_token }}
      
      - name: Deployment Summary
        if: always()
        run: |
          # Calculate deployment duration
          END_TIME=$(date +%s)
          START_TIME=${{ steps.deployment_timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          echo "================================"
          echo "üìä DEPLOYMENT SUMMARY"
          echo "================================"
          echo "Status: ${{ job.status }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "URL: ${{ inputs.site_url }}"
          echo "Duration: ${MINUTES}m ${SECONDS}s"
          echo "Completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "================================"
